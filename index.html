<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barclays Banque - Multi-Rôle et Chat</title>
    <!-- Inclure Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuration des polices et des classes personnalisées pour Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        .font-sans {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        /* Style de base pour les transitions */
        .animate-in {
            animation-name: fadeIn;
            animation-duration: 0.3s;
            animation-fill-mode: both;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-in-from-top-4 {
            animation-name: slideInTop;
        }
        @keyframes slideInTop {
            from { transform: translateY(-1rem); }
            to { transform: translateY(0); }
        }
        .slide-in-from-bottom-4 {
            animation-name: slideInBottom;
        }
        @keyframes slideInBottom {
            from { transform: translateY(1rem); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .zoom-in-95 {
            animation-name: zoomIn;
        }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        /* Simulation de l'icône de Contactless */
        .contactless-icon {
            transform: rotate(90deg);
        }

        /* Espace de 80px au bas du contenu principal pour la navigation en pied de page */
        .main-content {
            padding-bottom: 80px; 
        }
        /* La fenêtre de chat en mode non-modale doit occuper l'espace principal et avoir la bonne marge */
        .chat-container-main {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding-bottom: 80px; /* Laisser de l'espace pour la barre de navigation en bas */
        }
        /* Assurer que le chat en mode modale prend tout l'écran sur mobile */
        @media (max-width: 767px) {
            .chat-container-main {
                padding-bottom: 0; /* Pas besoin de marge car la nav est superposée */
            }
        }
    </style>
    <!-- Inclure React et ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Inclure Babel pour la compilation JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase CDN Imports (Required for real-time chat) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, setLogLevel, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase utilities globally for use in the main babel script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, 
            query, where, getDocs, orderBy, limit, serverTimestamp, setLogLevel, arrayUnion
        };
        
        // Configuration et Initialisation
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // CORRECTION: Utilisation de __firebase_config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = firebase.initializeApp(firebaseConfig);
                window.db = firebase.getFirestore(app);
                window.auth = firebase.getAuth(app);
                window.firebaseReady = true;

                // Sign in with custom token or anonymously
                const signInProcess = initialAuthToken 
                    ? firebase.signInWithCustomToken(window.auth, initialAuthToken)
                    : firebase.signInAnonymously(window.auth);

                signInProcess
                    .then(() => console.log("Firebase signed in."))
                    .catch(error => console.error("Firebase Auth Failed:", error));

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                window.firebaseReady = false;
            }
        } else {
            console.warn("Firebase config not available. Chat features will be limited.");
            window.firebaseReady = false;
        }

        // Expose critical identifiers
        window.appId = appId;
    </script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // SIMULATION DES ICONES LUCIDE-REACT
        // ==========================================
        const Bell = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18.8 12.3a4.5 4.5 0 0 0-4.5-4.5H9.7a4.5 4.5 0 0 0-4.5 4.5v1.2a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-1.2zm-4.3 8a2 2 0 0 1-4 0"/></svg>;
        const LogOut = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;
        const Home = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const ArrowRightLeft = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 11 20 14 17 17"/><line x1="4" y1="14" x2="20" y2="14"/><polyline points="7 7 4 10 7 13"/><line x1="20" y1="10" x2="4" y2="10"/></svg>;
        const CreditCard = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>;
        const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Landmark = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="22" x2="21" y2="22"/><path d="M4 14.897V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10.897M12 2l4 3.5M12 2l-4 3.5M9 8h6M6 18h12"/></svg>;
        const MessageSquare = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
        const Loader = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Send = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
        const Sparkles = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.9 22c-3.7-.8-6.6-4.5-6.6-7.8s2.9-7 6.6-7.8c.8 1.4 1.2 2.9 1.2 4.4 0 1.5-.4 3-1.2 4.4zm.8-13.4l.7-.7a1 1 0 0 1 1.4 0l.7.7m-2.8 1.4l.7-.7a1 1 0 0 1 1.4 0l.7.7"/><path d="M12 2c-.4 0-.7.3-1 .7a1.6 1.6 0 0 0-1.4 1.5c0 1.2.9 2 2 2 .5 0 1-.2 1.4-.6l1-1c.2-.3.3-.7 0-1L13 2.7c-.2-.4-.6-.7-1-.7z"/><path d="M13 14c0 1.5-.4 3-1.2 4.4-3.7-.8-6.6-4.5-6.6-7.8s2.9-7 6.6-7.8c.8 1.4 1.2 2.9 1.2 4.4z"/></svg>;
        const Eye = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"/><circle cx="12" cy="12" r="3"/></svg>;
        const EyeOff = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-10-7-10-7s.21-1.63 1.39-3.41m6.07-5.18 1.15 1.15c.3.3.48.72.58 1.16M2 2l20 20"/></svg>;
        const Mail = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>;
        const Clipboard = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></svg>;


        // ==========================================
        // DONNÉES FICTIVES INITIALES
        // ==========================================
        const INITIAL_DATA = {
            bankName: "BARCLAYS",
            user: {
                name: "Lacombe Jacques André marie",
                loginId: "72104699",
                password: "551299",
                role: 'client',
            },
            manager: {
                name: "Gestionnaire Privé",
                loginId: "1234",
                password: "123456",
                role: 'manager',
            },
            initialBalance: 804038,
            initialTransactions: [
                { id: 1, date: '21/11/2025', recipient: 'Londres royaume unis', account: 'xxxxxxxx', amount: 804038, type: 'credit', description: 'Solde initial' },
            ],
            notificationMessage: "Le bénéfice de 804 038 € a été réalisé grâce à des investissements effectués sur les marchés. Vos fonds ont été temporairement centralisés auprès de la banque Barclays avant d'être transférés sur vos comptes bancaires respectifs, en tant que bénéficiaire légitime de ces avoirs.",
            
            // Données réelles masquées pour les affichages
            IBAN_FULL: 'FR762000100012345678901', 
            CARD_NUMBER_FULL: '4970102345678910',
        };

        const formatCurrency = (amount, currency = 'EUR') => {
            return new Intl.NumberFormat('fr-FR', { 
                style: 'currency', 
                currency: currency, 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(amount);
        };

        // Fonction pour masquer les numéros de carte/IBAN
        const maskNumber = (fullNumber, visibleChars = 4, spacing = 4) => {
            if (!fullNumber) return '';
            const cleanNumber = fullNumber.replace(/[^0-9A-Z]/g, '');
            const maskedPart = '*'.repeat(cleanNumber.length - visibleChars);
            const visiblePart = cleanNumber.slice(-visibleChars);
            
            const masked = maskedPart;
            
            // Ajouter un espacement tous les 4 caractères pour la lisibilité
            // Utiliser un pattern plus générique pour IBANs longs
            const displayMasked = masked.match(new RegExp(`.{1,${spacing}}`, 'g')).join(' ');
            
            return displayMasked + ' ' + visiblePart;
        };


        // ==========================================
        // GEMINI API UTILS
        // ==========================================

        async function performGeminiApiCall(userQuery, systemPrompt, useSearch, maxRetries = 5, initialDelay = 1000) {
            const apiKey = ""; // Canvas will automatically provide the key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: useSearch ? [{ "google_search": {} }] : undefined,
                systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined,
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Retryable HTTP error: ${response.status}`);
                        }
                        const errorBody = await response.json();
                        console.error("Gemini API Non-retryable Error:", errorBody);
                        return { text: "Erreur: Le service LLM n'a pas pu traiter la requête.", sources: [] };
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    }

                    return { text: "Erreur: Réponse inattendue de l'API LLM.", sources: [] };

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("Gemini API failed after all retries:", error);
                        return { text: "Erreur: Le service LLM est indisponible. Veuillez réessayer plus tard.", sources: [] };
                    }
                    // Exponential backoff delay
                    const delay = initialDelay * Math.pow(2, attempt);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ==========================================
        // FIREBASE UTILS
        // ==========================================
        const CHAT_COLLECTION = "client_manager_chat";
        const ACCOUNT_DOC = "client_balance";

        // IMPORTANT FIX for Netlify/Deployment: Use a consistent, static ID for the client's public chat 
        // channel. Using the client's loginId ensures continuity across sessions and users (client/manager).
        const CHAT_CHANNEL_ID = INITIAL_DATA.user.loginId; 

        function getChatCollectionRef(db, appId) {
            // This collection will now hold documents named after the chat channel ID (the client's login ID)
            // Path: /artifacts/{appId}/public/data/client_manager_chat/{CHAT_CHANNEL_ID}/messages
            return window.firebase.collection(db, `artifacts/${appId}/public/data/${CHAT_COLLECTION}/${CHAT_CHANNEL_ID}/messages`);
        }
        
        function getClientDocRef(db, appId, userId) {
            // Path: /artifacts/{appId}/users/{userId}/account_data/client_balance
            // This is for private client data
            return window.firebase.doc(db, `artifacts/${appId}/users/${userId}/account_data/${ACCOUNT_DOC}`);
        }
        
        // ==========================================
        // MODAL COMPONENTS
        // ==========================================
        function EmailModal({ isOpen, onClose, emailContent, isGenerating }) {
            const [copied, setCopied] = React.useState(false);
            
            const handleCopy = () => {
                // Use execCommand('copy') for better compatibility inside iframes
                const el = document.createElement('textarea');
                el.value = emailContent.subject + '\n\n' + emailContent.body;
                document.body.appendChild(el);
                el.select();
                document.execCommand('copy');
                document.body.removeChild(el);
                
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in duration-300">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-in zoom-in-95 slide-in-from-bottom-4 flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-sky-500 rounded-t-xl">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                <Mail className="w-5 h-5" /> Email Formalisé IA
                            </h3>
                            <button onClick={onClose} className="text-white/80 hover:text-white p-1">
                                <X className="w-5 h-5" />
                            </button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto flex-1">
                            {isGenerating ? (
                                <div className="flex flex-col items-center justify-center h-48 text-slate-500">
                                    <Loader className="w-8 h-8 text-sky-500 mb-3" />
                                    <p>Génération de l'e-mail...</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="p-3 bg-slate-50 border border-slate-200 rounded-lg">
                                        <p className="text-sm font-semibold text-slate-600">Objet :</p>
                                        <p className="font-medium text-slate-800">{emailContent.subject}</p>
                                    </div>

                                    <div className="p-3 bg-white border border-slate-200 rounded-lg shadow-inner">
                                        <p className="whitespace-pre-wrap text-sm text-slate-700">{emailContent.body}</p>
                                    </div>
                                    
                                    <p className="text-xs text-slate-500 italic">Veuillez copier le contenu ci-dessus avant de fermer la fenêtre.</p>
                                </div>
                            )}
                        </div>

                        <div className="p-4 border-t flex justify-end">
                            <button 
                                onClick={handleCopy}
                                disabled={isGenerating}
                                className="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors disabled:bg-green-300 transform active:scale-[0.98]"
                            >
                                {copied ? (
                                    <>
                                        <Clipboard className="w-4 h-4" /> Copié !
                                    </>
                                ) : (
                                    <>
                                        <Clipboard className="w-4 h-4" /> Copier l'e-mail
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // CHAT COMPONENTS
        // ==========================================

        function ChatWindow({ db, auth, userId, userName, onClose, isManager }) {
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState('');
            const messagesEndRef = React.useRef(null);
            const [isSending, setIsSending] = React.useState(false);
            const [isBotResponding, setIsBotResponding] = React.useState(false); // New state for AI features
            const [isEmailModalOpen, setIsEmailModalOpen] = React.useState(false);
            const [emailDraft, setEmailDraft] = React.useState({ subject: '', body: '' });

            React.useEffect(() => {
                if (!db || !userId) return;

                const chatRef = getChatCollectionRef(db, window.appId);
                const q = window.firebase.query(chatRef, window.firebase.orderBy('timestamp', 'asc'));

                // Listen for real-time updates
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // Ensure timestamp is a Date object for comparison/display
                        timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date(),
                    }));
                    setMessages(msgs);
                }, (error) => {
                    console.error("Error listening to chat messages:", error);
                });

                return () => unsubscribe(); // Cleanup listener on unmount
            }, [db, userId]);

            // Scroll to bottom whenever messages update
            React.useEffect(() => {
                // Ensure scrolling happens after messages are rendered
                const timeout = setTimeout(() => {
                    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }, 100); 
                return () => clearTimeout(timeout);
            }, [messages]);


            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!input.trim() || isSending || !db || !userId) return;

                setIsSending(true);
                const chatRef = getChatCollectionRef(db, window.appId);

                try {
                    await window.firebase.addDoc(chatRef, {
                        senderId: userId,
                        senderName: userName,
                        text: input.trim(),
                        timestamp: window.firebase.serverTimestamp(),
                    });
                    setInput('');
                } catch (error) {
                    console.error("Error adding message:", error);
                } finally {
                    setIsSending(false);
                }
            };
            
            // --- GEMINI AI Client Feature: Financial Advice ---
            const handleAIFinancialAdvice = async () => {
                if (isBotResponding) return;

                // 1. Construct chat history context for the prompt
                const chatHistory = messages.map(msg => `${msg.senderName}: ${msg.text}`).join('\n');
                const fullPrompt = `Voici l'historique de la conversation entre le client et son gestionnaire bancaire:
    ---
    ${chatHistory}
    ---
    En vous basant sur cet historique et sur le contexte d'une banque privée (Barclays), fournissez une analyse concise (3 phrases maximum) sur la situation financière évoquée par le client et suggérez une prochaine étape pour l'aider (paiement de frais, contact, etc.).`;

                const systemPrompt = "Vous êtes un conseiller financier IA expert et discret de la banque Barclays. Vous analysez l'historique de chat du client et fournissez des conseils clairs, précis et réconfortants, en français.";

                setIsBotResponding(true);
                
                // Create a placeholder message for the AI response
                const botPlaceholder = {
                    id: 'bot-loading-' + Date.now(),
                    senderName: 'Conseiller IA Barclays',
                    text: 'Analyse en cours... veuillez patienter.',
                    type: 'bot',
                    timestamp: new Date(),
                    isPlaceholder: true,
                    senderId: 'AI_BOT'
                };
                
                setMessages(prev => [...prev, botPlaceholder]);
                
                // Use setTimeout to ensure the loading message is rendered before scrolling and calling the API
                setTimeout(async () => {
                    try {
                        const result = await performGeminiApiCall(fullPrompt, systemPrompt, false);

                        const finalMessage = {
                            id: 'bot-final-' + Date.now(),
                            senderName: 'Conseiller IA Barclays',
                            text: result.text,
                            type: 'bot',
                            timestamp: new Date(),
                            senderId: 'AI_BOT'
                        };

                        // Replace the placeholder with the final message
                        setMessages(prev => prev.map(msg => msg.id === botPlaceholder.id ? finalMessage : msg));

                    } catch (error) {
                        console.error("AI call failed:", error);
                        setMessages(prev => prev.map(msg => msg.id === botPlaceholder.id ? { ...msg, text: "Erreur lors de la communication avec le Conseiller IA.", isPlaceholder: false } : msg));
                    } finally {
                        setIsBotResponding(false);
                    }
                }, 100); 
            };

            // --- GEMINI AI Manager Feature: Draft Professional Response ---
            const handleManagerDraftResponse = async () => {
                if (isBotResponding) return;
                
                // Find the last message sent by the client (senderId is not the current manager's userId and not the AI bot)
                const lastClientMessage = messages.findLast(msg => msg.senderId !== userId && msg.senderId !== 'AI_BOT');

                if (!lastClientMessage) {
                    setInput("Aucun message client récent trouvé pour rédiger une réponse.");
                    return;
                }

                const clientQuery = lastClientMessage.text;
                const fullPrompt = `Le client a envoyé le message suivant : "${clientQuery}". Rédigez une réponse professionnelle, formelle et rassurante du Gestionnaire Privé de la banque Barclays. La réponse doit être en français et ne doit pas dépasser 4 phrases.`;
                const systemPrompt = "Vous êtes un gestionnaire privé de la banque Barclays. Votre ton est formel, courtois et orienté solution. Vous répondez au client de manière professionnelle.";

                setIsBotResponding(true);
                setInput('Génération de la réponse professionnelle...');

                try {
                    const result = await performGeminiApiCall(fullPrompt, systemPrompt, false);
                    
                    // Replace the input with the drafted response
                    setInput(result.text);

                } catch (error) {
                    console.error("AI call failed:", error);
                    setInput('Erreur: Impossible de générer la réponse. Veuillez réessayer.');
                } finally {
                    setIsBotResponding(false);
                }
            };
            
            // --- GEMINI AI Manager Feature: Generate Formal Email ---
            const handleGenerateEmail = async () => {
                if (isBotResponding) return;

                setIsEmailModalOpen(true);
                setIsBotResponding(true);
                setEmailDraft({ subject: 'Génération en cours...', body: 'Veuillez patienter...' });

                const draftText = input.trim() || "Je prends note de votre préoccupation et je vais vous fournir une réponse formelle dès que possible.";
                
                const fullPrompt = `Convertissez le brouillon de message suivant : "${draftText}" en un e-mail professionnel et formel. L'e-mail doit inclure un objet pertinent, une salutation formelle ("Cher M. Lacombe,"), le corps du texte (basé sur le brouillon fourni), et une clôture formelle ("Cordialement,") signée par le Gestionnaire Privé. Répondez uniquement avec l'Objet et le Corps de l'e-mail, séparés par une ligne vide.`;

                const systemPrompt = "Vous êtes un assistant IA pour un Gestionnaire Privé de la banque Barclays. Vous transformez des notes ou des brouillons en communications clients formelles, professionnelles et structurées, en français.";

                try {
                    const result = await performGeminiApiCall(fullPrompt, systemPrompt, false);
                    
                    // Attempt to parse the result into subject and body
                    const parts = result.text.split('\n\n');
                    let subject = 'Objet généré par l\'IA';
                    let body = result.text;
                    
                    if (parts.length >= 2) {
                        // Assume the first part is the subject
                        subject = parts[0].replace(/Objet\s*:\s*/i, '').trim();
                        // Join the rest as the body
                        body = parts.slice(1).join('\n\n');
                    }
                    
                    setEmailDraft({ subject: subject, body: body });
                    setInput(''); // Clear input after drafting the email
                } catch (error) {
                    console.error("AI Email call failed:", error);
                    setEmailDraft({ subject: 'Erreur de génération', body: 'Impossible de générer l\'e-mail. Veuillez réessayer.' });
                } finally {
                    setIsBotResponding(false);
                }
            };
            
            // --- End AI Features ---

            const ManagerBadge = ({ name }) => (
                <span className="bg-sky-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">
                    {name}
                </span>
            );

            const BotBadge = () => (
                <span className="bg-purple-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">
                    Conseiller IA
                </span>
            );


            return (
                <>
                    <EmailModal isOpen={isEmailModalOpen} onClose={() => setIsEmailModalOpen(false)} emailContent={emailDraft} isGenerating={isBotResponding} />

                    <div className={`flex flex-col h-full ${!isManager && 'md:absolute md:top-0 md:left-0 md:right-0 md:bottom-0 md:rounded-xl'}`}>
                        <div className="flex justify-between items-center p-4 border-b bg-sky-500 text-white rounded-t-xl shadow-md flex-shrink-0">
                            <h2 className="text-lg font-bold flex items-center gap-2">
                                <MessageSquare className="w-5 h-5" />
                                {isManager ? 'Dialogue Client' : 'Discuter avec votre Gestionnaire'}
                            </h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-white/20 transition-colors">
                                <X className="w-5 h-5" />
                            </button>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                            {messages.length === 0 && (
                                <div className="text-center p-6 text-slate-500 italic">
                                    Il n'y a pas encore de messages. Commencez la discussion !
                                </div>
                            )}
                            {messages.map((msg) => {
                                const isMyMessage = msg.senderId === userId;
                                const isBotMessage = msg.senderId === 'AI_BOT';
                                const timeString = msg.timestamp.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                                return (
                                    <div key={msg.id} className={`flex ${isMyMessage || isBotMessage ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${
                                            isMyMessage 
                                                ? 'bg-sky-500 text-white rounded-br-none' 
                                                : (isBotMessage 
                                                    ? 'bg-purple-100 text-slate-800 rounded-bl-none border border-purple-200'
                                                    : 'bg-white text-slate-800 rounded-tl-none border border-slate-200')
                                        }`}>
                                            <div className={`text-xs mb-1 font-semibold flex items-center gap-2 ${isMyMessage ? 'text-sky-100' : 'text-slate-600'}`}>
                                                {!isMyMessage && !isBotMessage && <ManagerBadge name={msg.senderName.split(' ')[0]} />}
                                                {isBotMessage && <BotBadge />} 
                                                {isMyMessage && msg.senderName.split(' ')[0]}
                                            </div>
                                            <p className="text-sm break-words whitespace-pre-wrap">
                                                {msg.isPlaceholder && isBotResponding ? <Loader className="w-4 h-4 mr-2 inline-block text-purple-600" /> : null}
                                                {msg.text}
                                            </p>
                                            <span className={`block text-right mt-1 ${isMyMessage ? 'text-xs text-sky-200' : (isBotMessage ? 'text-xs text-purple-400' : 'text-xs text-slate-400')}`}>
                                                {timeString}
                                            </span>
                                        </div>
                                    </div>
                                );
                            })}
                            <div ref={messagesEndRef} />
                        </div>

                        <div className="p-4 border-t bg-white flex-shrink-0">
                            {/* AI Features Row */}
                            <div className="mb-3 flex gap-2 overflow-x-auto pb-1">
                                {!isManager && (
                                    <button
                                        onClick={handleAIFinancialAdvice}
                                        disabled={isBotResponding || messages.length === 0}
                                        className="flex-shrink-0 text-xs px-3 py-2 bg-purple-500 text-white rounded-full font-medium hover:bg-purple-600 disabled:bg-purple-300 transition-colors flex items-center gap-1 shadow-md"
                                    >
                                        <Sparkles className="w-3 h-3"/>
                                        Aide Financière IA
                                    </button>
                                )}
                                {isManager && (
                                    <>
                                        <button
                                            onClick={handleManagerDraftResponse}
                                            disabled={isBotResponding || messages.filter(m => m.senderId !== userId && m.senderId !== 'AI_BOT').length === 0}
                                            className="flex-shrink-0 text-xs px-3 py-2 bg-purple-500 text-white rounded-full font-medium hover:bg-purple-600 disabled:bg-purple-300 transition-colors flex items-center gap-1 shadow-md"
                                        >
                                            <Sparkles className="w-3 h-3"/>
                                            Réponse Pro IA
                                        </button>
                                        <button
                                            onClick={handleGenerateEmail}
                                            disabled={isBotResponding || !input.trim()}
                                            className="flex-shrink-0 text-xs px-3 py-2 bg-indigo-500 text-white rounded-full font-medium hover:bg-indigo-600 disabled:bg-indigo-300 transition-colors flex items-center gap-1 shadow-md"
                                        >
                                            <Mail className="w-3 h-3"/>
                                            Email Formalisé IA
                                        </button>
                                    </>
                                )}
                            </div>

                            <form onSubmit={handleSendMessage} className="flex gap-3">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Écrire un message..."
                                    className="flex-1 px-4 py-2.5 rounded-full border border-slate-200 focus:border-sky-500 focus:ring-1 focus:ring-sky-100 outline-none"
                                    disabled={isSending || isBotResponding || !db || !userId}
                                />
                                <button 
                                    type="submit" 
                                    className="p-3 bg-sky-500 hover:bg-sky-600 text-white rounded-full transition-colors disabled:bg-sky-300"
                                    disabled={isSending || isBotResponding || !input.trim() || !db || !userId}
                                >
                                    {isSending ? <Loader className="w-5 h-5" /> : <Send className="w-5 h-5" />}
                                </button>
                            </form>
                        </div>
                    </div>
                </>
            );
        }

        // ==========================================
        // VUES
        // ==========================================

        function LoginPage({ onLoginSuccess, correctClient, correctManager, bankName }) {
            const [loginId, setLoginId] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');

                let user = null;

                if (loginId === correctClient.loginId && password === correctClient.password) {
                    user = correctClient;
                } else if (loginId === correctManager.loginId && password === correctManager.password) {
                    user = correctManager;
                }
                
                if (user) {
                    onLoginSuccess(user);
                } else {
                    setError("Identifiants incorrects. Veuillez réessayer.");
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-sky-100 to-white p-4">
                    <div className="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95">
                        <div className="bg-sky-500 p-6 text-center">
                            <div className="inline-block p-3 rounded-full bg-white/20 mb-2">
                                <Landmark className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-bold text-white tracking-wider">{bankName}</h1>
                            <p className="text-sky-100 text-sm mt-1">Accès Sécurisé</p>
                        </div>
                        
                        <div className="p-8">
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Identifiant</label>
                                    <input 
                                        type="text" 
                                        value={loginId} 
                                        onChange={(e) => setLoginId(e.target.value)} 
                                        className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none transition-all bg-slate-50 focus:bg-white"
                                        placeholder="Entrez votre identifiant"
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Mot de passe</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none transition-all bg-slate-50 focus:bg-white"
                                        placeholder="••••••"
                                        required 
                                    />
                                </div>
                                
                                {error && (
                                    <div className="p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-lg flex items-center">
                                        <span className="mr-2">⚠</span> {error}
                                    </div>
                                )}

                                <button type="submit" className="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg shadow-sky-500/30 transition-all transform active:scale-[0.98]">
                                    Se connecter
                                </button>
                                
                                <div className="text-center pt-2 text-xs text-slate-400">
                                    <p>Client ID: 72104699 | Pass: 551299</p>
                                    <p>Manager ID: 1234 | Pass: 123456</p>
                                </div>
                                
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function Header({ userName, bankName, onLogout, onToggleNotification, notificationActive }) {
            return (
                <header className="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 py-3 md:px-6 flex justify-between items-center shadow-sm">
                    <div className="flex items-center gap-2">
                        <div className="bg-sky-500 p-1.5 rounded-lg">
                            <Landmark className="text-white w-5 h-5" />
                        </div>
                        <span className="font-bold text-xl text-sky-600 tracking-tight">{bankName}</span>
                    </div>
                    
                    <div className="flex items-center gap-3 md:gap-6">
                        <span className="hidden md:block text-sm font-medium text-slate-600">
                            Bonjour, <span className="text-slate-900 font-bold">{userName.split(' ')[0]}</span>
                        </span>
                        
                        {/* Notification Button is only relevant for Client Dashboard */}
                        {onToggleNotification && (
                            <button 
                                onClick={onToggleNotification}
                                className={`relative p-2 rounded-full transition-colors ${notificationActive ? 'bg-sky-50 text-sky-600' : 'hover:bg-slate-100 text-slate-500'}`}
                            >
                                <Bell className="w-5 h-5" />
                                {notificationActive && (
                                    <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full"></span>
                                )}
                            </button>
                        )}
                        
                        <button 
                            onClick={onLogout} 
                            className="flex items-center gap-2 text-slate-500 hover:text-red-500 transition-colors text-sm font-medium"
                        >
                            <span className="hidden md:inline">Déconnexion</span>
                            <LogOut className="w-4 h-4" />
                        </button>
                    </div>
                </header>
            );
        }

        function Navigation({ currentView, setCurrentView, onOpenChat }) {
            const navItems = [
                { id: 'dashboard', label: 'Tableau de bord', icon: Home },
                { id: 'transfer', label: 'Virement', icon: ArrowRightLeft },
                { id: 'card', label: 'Carte', icon: CreditCard },
                { id: 'chat', label: 'Dialogue', icon: MessageSquare, action: onOpenChat, type: 'button' },
            ];

            return (
                // La navigation est maintenant fixée en bas pour tous les appareils
                <nav className="bg-white border-t border-slate-200 flex justify-around fixed bottom-0 w-full h-[70px] z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] p-2 md:p-4 gap-1">
                    {navItems.map((item) => {
                        const Icon = item.icon;
                        const isActive = currentView === item.id;
                        const action = item.action || (() => setCurrentView(item.id));

                        return (
                            <button
                                key={item.id}
                                onClick={action}
                                className={`flex flex-col items-center md:flex-row md:gap-3 p-1 md:px-4 md:py-3 rounded-lg transition-all w-full md:text-left text-xs md:text-sm font-medium
                                    ${isActive && item.id !== 'chat'
                                        ? 'text-sky-600 bg-sky-50 md:bg-sky-50' 
                                        : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'}`}
                            >
                                <Icon className={`w-6 h-6 md:w-5 md:h-5 mb-0.5 md:mb-0 ${isActive && item.id !== 'chat' ? 'stroke-[2.5px]' : ''}`} />
                                <span>{item.label}</span>
                            </button>
                        );
                    })}
                </nav>
            );
        }

        function DashboardView({ balance, transactions, onOpenChat }) {
            const [isBalanceVisible, setIsBalanceVisible] = React.useState(true);
            const IBAN_MASKED = maskNumber(INITIAL_DATA.IBAN_FULL, 4, 4);

            const displayBalance = isBalanceVisible 
                ? formatCurrency(balance) 
                : '*,** €';

            return (
                <div className="space-y-6 animate-in fade-in zoom-in-95 duration-300">
                    {/* Balance Card */}
                    <div className="bg-gradient-to-r from-sky-500 to-sky-600 rounded-2xl p-6 text-white shadow-lg shadow-sky-500/20 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-32 blur-2xl"></div>
                        <div className="relative z-10">
                            <h2 className="text-sky-100 text-sm font-medium mb-1 flex justify-between items-center">
                                Solde disponible
                                <button onClick={() => setIsBalanceVisible(!isBalanceVisible)} className="p-1 rounded-full hover:bg-white/20 transition-colors">
                                    {isBalanceVisible ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
                                </button>
                            </h2>
                            <p className="text-4xl font-bold mb-4 font-mono">{displayBalance}</p>
                            <div className="flex items-center justify-between bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                                <div>
                                    <p className="text-xs text-sky-100">IBAN</p>
                                    {/* IBAN masqué */}
                                    <p className="font-mono text-sm">{IBAN_MASKED}</p>
                                </div>
                                <CreditCard className="w-6 h-6 text-sky-200" />
                            </div>
                        </div>
                    </div>

                    {/* Quick Action - Chat */}
                    <div className="flex justify-center md:justify-start">
                        <button 
                            onClick={onOpenChat}
                            className="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg shadow-purple-500/30 transition-all transform active:scale-[0.98]"
                        >
                            <MessageSquare className="w-5 h-5" />
                            Écrire à mon Gestionnaire
                        </button>
                    </div>

                    {/* Transactions */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 className="font-semibold text-slate-700">Historique des transactions</h3>
                            <span className="text-xs font-medium text-sky-600 bg-sky-50 px-2 py-1 rounded-full">Dernières</span>
                        </div>
                        <ul className="divide-y divide-slate-100">
                            {transactions.map(tx => (
                                <li key={tx.id} className="px-6 py-4 hover:bg-slate-50 transition-colors flex items-center justify-between group">
                                    <div className="flex items-start gap-4">
                                        <div className={`p-2 rounded-full ${tx.type === 'debit' ? 'bg-slate-100 text-slate-500' : 'bg-green-100 text-green-600'}`}>
                                            {tx.type === 'debit' ? <ArrowRightLeft className="w-5 h-5" /> : <ArrowRightLeft className="w-5 h-5 rotate-180" />}
                                        </div>
                                        <div>
                                            <p className="font-medium text-slate-900">{tx.recipient}</p>
                                            <p className="text-sm text-slate-500 font-mono">{tx.account}</p>
                                            {tx.description && <p className="text-xs text-slate-400 mt-0.5 italic">{tx.description}</p>}
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`font-bold ${tx.type === 'debit' ? 'text-red-600' : 'text-green-600'}`}>
                                            {tx.type === 'credit' && tx.amount > 0 && '+'}{formatCurrency(tx.amount)}
                                        </p>
                                        <p className="text-xs text-slate-400">{tx.date}</p>
                                    </div>
                                </li>
                            ))}
                        </ul>
                        {transactions.length === 0 && (
                            <div className="text-center p-8 text-slate-500 italic">
                                Aucune transaction récente.
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function TransferView({ balance, clientUserId }) {
            const [formData, setFormData] = React.useState({
                securityCode: '',
                iban: '',
                bic: '',
                amount: '',
                bankName: '',
                transferType: 'Virement international', // Default to INT for scenario
                recipientName: '',
                reason: ''
            });
            const [message, setMessage] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(false);
            const [showAIBtn, setShowAIBtn] = React.useState(false); // New state for AI button
            const [isBotExplaining, setIsBotExplaining] = React.useState(false);
            
            const db = window.firebaseReady ? window.db : null;

            const handleChange = (e) => {
                const { name, value } = e.target;
                const newValue = name === 'amount' && parseFloat(value) < 0 
                                     ? Math.abs(parseFloat(value)) 
                                     : value;
                setFormData({ ...formData, [name]: newValue });
                setMessage(null);
                setShowAIBtn(false); // Hide AI button on new input
            };

            const updateClientData = async (newBalance, newTransaction) => {
                if (!db || !clientUserId) return;
                const docRef = getClientDocRef(db, window.appId, clientUserId);

                try {
                    // Fetch existing data to append transaction
                    const docSnap = await window.firebase.getDoc(docRef);
                    let existingTransactions = docSnap.exists() ? docSnap.data().transactions || [] : [];
                    
                    // Create new array with the new transaction added at the beginning
                    const updatedTransactions = [newTransaction, ...existingTransactions.filter(tx => tx.id !== newTransaction.id).slice(0, 4)]; 

                    await window.firebase.setDoc(docRef, {
                        balance: newBalance,
                        transactions: updatedTransactions,
                        lastUpdate: window.firebase.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error("Error updating client data:", error);
                }
            };
            
            // --- GEMINI AI Client Feature: Explain Fees ---
            const handleExplainFees = async () => {
                if (isBotExplaining) return;
                
                setIsBotExplaining(true);
                const userQuery = `Expliquez-moi en trois phrases simples et professionnelles pourquoi mon virement international vers ${formData.recipientName} (IBAN: ${formData.iban.slice(-4)}) a échoué à cause de frais SWIFT de 1%, et quelle est la prochaine étape pour débloquer le montant de ${formatCurrency(parseFloat(formData.amount))} de manière sécurisée.`;
                const systemPrompt = "Vous êtes un agent de support bancaire IA de Barclays. Votre rôle est de fournir des explications claires et de rassurer le client. La réponse doit être en français et ne doit pas dépasser 3 phrases concises et polies. N'ajoutez pas de salutation.";

                try {
                    const result = await performGeminiApiCall(userQuery, systemPrompt, false);
                    
                    setMessage({
                        type: 'info',
                        text: (
                            <div className="text-sm">
                                <p className="font-bold mb-2 flex items-center gap-2"><Sparkles className="w-4 h-4 text-purple-600"/> Explication du Conseiller IA</p>
                                <p className="leading-relaxed">{result.text}</p>
                            </div>
                        )
                    });
                    
                } catch (error) {
                    console.error("AI Fee explanation failed:", error);
                    setMessage({ type: 'error', text: "Erreur: Impossible d'obtenir l'explication IA. Veuillez contacter votre gestionnaire directement." });
                } finally {
                    setIsBotExplaining(false);
                }
            };
            
            // --- End AI Feature ---

            const handleSubmit = (e) => {
                e.preventDefault();
                const amountNum = parseFloat(formData.amount);
                
                if (!formData.recipientName || !formData.iban || amountNum <= 0) {
                    setMessage({ type: 'error', text: "Veuillez remplir les champs obligatoires (Montant, IBAN, Nom du bénéficiaire) avec des valeurs valides." });
                    setShowAIBtn(false);
                    return;
                }
                
                if (amountNum > balance) {
                    setMessage({ type: 'error', text: "Solde insuffisant pour effectuer ce virement." });
                    setShowAIBtn(false);
                    return;
                }

                setIsLoading(true);
                setMessage({ type: 'info', text: "Traitement du virement international en cours... (Simulation de 5 minutes)" });

                // Simulation de 5 minutes (3 secondes réelles)
                setTimeout(async () => {
                    setIsLoading(false);
                    
                    // --- SCENARIO: Forced SWIFT Failure ---
                    const failedAmount = amountNum; 
                    const feeRate = 0.01;
                    const fee = parseFloat((failedAmount * feeRate).toFixed(2));
                    const remainingBalance = balance - fee; 

                    const failedTransaction = {
                        id: Date.now(),
                        date: new Date().toLocaleDateString('fr-FR'),
                        recipient: formData.recipientName,
                        account: maskNumber(formData.iban, 4, 4), // Store masked
                        amount: -fee,
                        type: 'debit',
                        description: 'Frais de virement SWIFT (Échec de transaction)',
                        status: 'Failed'
                    };

                    // 1. Update the balance to deduct the fee (only if balance is sufficient)
                    if (remainingBalance >= 0) {
                        await updateClientData(remainingBalance, failedTransaction);
                    } else {
                        console.error("Not enough balance to deduct the fee.");
                        // Handle case where fee itself depletes balance (unlikely with 1% of 800k)
                    }

                    // 2. Display the detailed failure message
                    setMessage({
                        type: 'error',
                        text: (
                            <div className="text-sm">
                                <p className="font-bold mb-2">ÉCHEC DE TRANSACTION (Nécessite une intervention)</p>
                                <ul className="list-disc list-inside space-y-0.5 mb-3">
                                    <li>Nom du bénéficiaire: {formData.recipientName}</li>
                                    <li>IBAN / Numéro de Compte: {formData.iban}</li>
                                    <li>Montant Initial: {formatCurrency(failedAmount)}</li>
                                    <li>Frais Déduits: {formatCurrency(fee)}</li>
                                </ul>
                                <p className="mt-2 leading-relaxed">
                                    Nous vous notifions que la transaction a été interrompue en raison de l'application obligatoire de frais de virement SWIFT (International) s'élevant à 1% du montant total. 
                                    <span className="font-bold block mt-1">Veuillez contacter votre gestionnaire pour autoriser le paiement de ces frais afin de débloquer le virement.</span>
                                </p>
                            </div>
                        )
                    });
                    
                    // Show AI button after failure
                    setShowAIBtn(true); 
                    
                    // Reset form after simulated attempt (optional: only amount/security code)
                    setFormData(prev => ({ ...prev, securityCode: '', amount: '' }));

                }, 3000); // 3 seconds simulation of 5 minutes
            };

            const inputClasses = "w-full px-4 py-2.5 rounded-lg border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-100 outline-none transition-all";

            return (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6 md:p-8 animate-in fade-in slide-in-from-bottom-4 duration-300">
                    <div className="mb-6">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <ArrowRightLeft className="text-sky-500" /> Virement Bancaire
                        </h2>
                        <p className="text-slate-500 text-sm">Votre solde actuel : <span className="font-bold text-slate-800">{formatCurrency(balance)}</span>. Remplissez les informations ci-dessous.</p>
                    </div>

                    {message && (
                        <div className={`mb-6 p-4 rounded-lg text-sm ${
                            message.type === 'error' ? 'bg-red-50 text-red-600 border border-red-200' : 
                            message.type === 'info' ? 'bg-yellow-50 text-yellow-600 border border-yellow-200' : 
                            'bg-green-50 text-green-600 border border-green-200'
                        }`}>
                            {message.text}
                            {/* AI Explain Fees Button */}
                            {showAIBtn && message.type === 'error' && (
                                <div className="mt-3">
                                    <button
                                        onClick={handleExplainFees}
                                        disabled={isBotExplaining}
                                        className="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all transform active:scale-[0.98] text-xs"
                                    >
                                        {isBotExplaining ? <Loader className="w-4 h-4" /> : <Sparkles className="w-4 h-4"/>}
                                        {isBotExplaining ? "Analyse..." : "Demander l'explication IA"}
                                    </button>
                                </div>
                            )}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-6">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Recipient Name */}
                            <div>
                                <label htmlFor="recipientName" className="block text-sm font-medium text-slate-700 mb-1">Nom du bénéficiaire</label>
                                <input 
                                    type="text" 
                                    id="recipientName"
                                    name="recipientName" 
                                    value={formData.recipientName} 
                                    onChange={handleChange} 
                                    className={inputClasses}
                                    placeholder="Ex: John Smith"
                                    required
                                />
                            </div>
                            {/* IBAN */}
                            <div>
                                <label htmlFor="iban" className="block text-sm font-medium text-slate-700 mb-1">IBAN / Numéro de Compte</label>
                                <input 
                                    type="text" 
                                    id="iban"
                                    name="iban" 
                                    value={formData.iban} 
                                    onChange={handleChange} 
                                    className={inputClasses}
                                    placeholder="FR76XXXXXXXXXXXXX"
                                    required
                                />
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-6">
                            {/* Amount */}
                            <div>
                                <label htmlFor="amount" className="block text-sm font-medium text-slate-700 mb-1">Montant à transférer (€)</label>
                                <input 
                                    type="number" 
                                    id="amount"
                                    name="amount" 
                                    value={formData.amount} 
                                    onChange={handleChange} 
                                    className={inputClasses}
                                    placeholder="804038.00"
                                    step="0.01"
                                    required
                                />
                            </div>
                            {/* Security Code */}
                            <div>
                                <label htmlFor="securityCode" className="block text-sm font-medium text-slate-700 mb-1">Code de Sécurité (6 chiffres)</label>
                                <input 
                                    type="password" 
                                    id="securityCode"
                                    name="securityCode" 
                                    value={formData.securityCode} 
                                    onChange={handleChange} 
                                    className={inputClasses}
                                    placeholder="••••••"
                                    maxLength="6"
                                    required
                                />
                            </div>
                        </div>
                        {/* Description / Reason */}
                        <div>
                            <label htmlFor="reason" className="block text-sm font-medium text-slate-700 mb-1">Motif du virement (Optionnel)</label>
                            <input 
                                type="text" 
                                id="reason"
                                name="reason" 
                                value={formData.reason} 
                                onChange={handleChange} 
                                className={inputClasses}
                                placeholder="Transfert de fonds personnel"
                            />
                        </div>

                        {/* Submit Button */}
                        <button 
                            type="submit" 
                            disabled={isLoading || isBotExplaining}
                            className="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg shadow-sky-500/30 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 disabled:bg-sky-300"
                        >
                            {isLoading ? <Loader className="w-5 h-5" /> : <ArrowRightLeft className="w-5 h-5" />}
                            {isLoading ? "Virement en cours..." : "Confirmer le Virement International"}
                        </button>
                    </form>
                </div>
            );
        }

        function CardView({ userName }) {
            const [isCardVisible, setIsCardVisible] = React.useState(false);
            const CARD_FULL = INITIAL_DATA.CARD_NUMBER_FULL;
            const CARD_MASKED = maskNumber(CARD_FULL, 4, 4);
            const CARD_EXPIRY = '09/27'; // Fictif
            const CARD_HOLDER = userName.toUpperCase();

            const displayCardNumber = isCardVisible ? CARD_FULL.match(/.{1,4}/g).join(' ') : CARD_MASKED;
            const displayCVV = isCardVisible ? '456' : '•••';
            
            // SVG for the contactless icon (a simple simulation)
            const ContactlessIcon = (props) => (
                <svg {...props} width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" className="contactless-icon">
                    <path d="M7 16V9C7 5.13401 10.134 2 14 2" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M7 23V23C13.0751 23 18 18.0751 18 12" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                    <path d="M7 30V30C16.9411 30 25 21.9411 25 12" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/>
                </svg>
            );

            return (
                <div className="space-y-6 animate-in fade-in slide-in-from-top-4 duration-300">
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <CreditCard className="text-sky-500" /> Gestion de ma Carte
                    </h2>
                    <p className="text-slate-500 text-sm">Aperçu et contrôle des informations de votre carte bancaire.</p>

                    {/* Simulated Bank Card */}
                    <div className="max-w-md mx-auto relative transform transition-transform duration-500 rounded-xl shadow-2xl">
                        <div className="bg-gradient-to-br from-indigo-800 to-sky-700 text-white p-6 rounded-xl h-52 flex flex-col justify-between">
                            <div className="flex justify-between items-start">
                                <div className="text-xl font-extrabold tracking-wider">{INITIAL_DATA.bankName}</div>
                                <ContactlessIcon className="w-8 h-8 text-white/90" />
                            </div>
                            
                            <div className="font-mono text-xl md:text-2xl font-semibold tracking-widest mt-4">
                                {displayCardNumber}
                            </div>

                            <div className="flex justify-between items-center text-sm font-medium mt-4">
                                <div>
                                    <div className="text-xs text-indigo-200">Titulaire</div>
                                    <div className="text-sm">{CARD_HOLDER}</div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <div>
                                        <div className="text-xs text-indigo-200">Expire</div>
                                        <div className="text-sm">{CARD_EXPIRY}</div>
                                    </div>
                                    <div className="text-lg font-bold">VISA</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Card Actions */}
                    <div className="max-w-md mx-auto p-4 bg-white rounded-xl border border-slate-200 shadow-sm space-y-4">
                        <div className="flex justify-between items-center">
                            <p className="text-slate-700 font-medium">Afficher les Détails de la Carte</p>
                            <button
                                onClick={() => setIsCardVisible(!isCardVisible)}
                                className="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold py-2 px-3 rounded-lg transition-colors text-sm"
                            >
                                {isCardVisible ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}
                                {isCardVisible ? 'Masquer' : 'Afficher'}
                            </button>
                        </div>

                        {isCardVisible && (
                            <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm animate-in fade-in">
                                <p className="font-bold mb-1">Code de Sécurité (CVV) : <span className="font-mono text-lg ml-1">{displayCVV}</span></p>
                                <p className="text-xs italic">Attention : Ne partagez jamais ces informations. Ceci est une simulation.</p>
                            </div>
                        )}
                        
                        <p className="text-sm text-slate-500">Pour des raisons de sécurité, le numéro complet n'est pas affiché par défaut. Utilisez le bouton "Afficher" pour le révéler temporairement.</p>
                    </div>
                    
                </div>
            );
        }

        function ManagerDashboard() {
            return (
                <div className="p-4 md:p-8">
                    <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in zoom-in-95 duration-300">
                        <div className="bg-white p-6 rounded-xl border border-sky-200 shadow-lg">
                            <h2 className="text-2xl font-bold text-sky-800 mb-4 flex items-center gap-2">
                                <MessageSquare className="w-6 h-6 text-sky-500" /> Interface Gestionnaire
                            </h2>
                            <p className="text-slate-600">
                                Bienvenue, <span className="font-semibold">{INITIAL_DATA.manager.name}</span>. Cette interface est dédiée à la communication et à la gestion de la relation client.
                            </p>
                        </div>

                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden min-h-[500px] flex">
                            {/* The Chat window takes the entire remaining space */}
                            <ChatWindow 
                                db={window.db} 
                                auth={window.auth}
                                userId={window.auth?.currentUser?.uid || 'manager-id-placeholder'} 
                                userName={INITIAL_DATA.manager.name} 
                                onClose={() => {}} // Manager chat doesn't close on the dashboard
                                isManager={true}
                            />
                        </div>
                    </div>
                </div>
            );
        }
        
        // ==========================================
        // MAIN APPLICATION COMPONENT
        // ==========================================
        function App() {
            // New state for Firebase Auth readiness and User ID (needed for Firestore paths)
            const [firebaseDb, setFirebaseDb] = React.useState(null);
            const [currentUserId, setCurrentUserId] = React.useState(null);
            const [isAuthReady, setIsAuthReady] = React.useState(false);
            
            // Existing states for app data
            const [user, setUser] = React.useState(null);
            const [currentView, setCurrentView] = React.useState('dashboard');
            const [isChatOpen, setIsChatOpen] = React.useState(false);
            const [notificationActive, setNotificationActive] = React.useState(true);

            // Dynamic data from Firestore
            const [clientBalance, setClientBalance] = React.useState(INITIAL_DATA.initialBalance);
            const [clientTransactions, setClientTransactions] = React.useState(INITIAL_DATA.initialTransactions);
            
            // --- Authentication and Firestore Setup ---
            React.useEffect(() => {
                // Wait for global Firebase objects to be available
                if (typeof window.firebaseReady === 'undefined' || !window.db || !window.auth) {
                    console.warn("Firebase not ready or configuration missing.");
                    return;
                }

                const auth = window.auth;
                const db = window.db;
                setFirebaseDb(db); // Set the DB instance once ready

                // Listen for Auth State Changes
                const unsubscribeAuth = window.firebase.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // If the user object is received, authentication is complete.
                        setCurrentUserId(user.uid);
                    } else {
                        // Should only happen if initial sign-in failed, but set to ready anyway.
                        // Use a fallback UID if not authenticated (shouldn't happen with custom token/anonymous sign-in)
                        setCurrentUserId(auth.currentUser?.uid || crypto.randomUUID()); 
                    }
                    setIsAuthReady(true);
                }, (error) => {
                    console.error("Auth state listener error:", error);
                    setIsAuthReady(true); // Ensure app doesn't hang on error
                });

                return () => unsubscribeAuth();
            }, []); // Run only once on mount

            // --- Data Listener (Runs only after auth is ready and user is logged in as 'client') ---
            React.useEffect(() => {
                if (!isAuthReady || !firebaseDb || !user || user.role !== 'client' || !currentUserId) return;
                
                const docRef = getClientDocRef(firebaseDb, window.appId, currentUserId);

                const unsubscribeSnapshot = window.firebase.onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setClientBalance(data.balance);
                        setClientTransactions(data.transactions || INITIAL_DATA.initialTransactions);
                    } else {
                        // If the document doesn't exist, initialize it with default data
                        window.firebase.setDoc(docRef, {
                            balance: INITIAL_DATA.initialBalance,
                            transactions: INITIAL_DATA.initialTransactions,
                            userId: currentUserId,
                            created: window.firebase.serverTimestamp()
                        }, { merge: true }).then(() => {
                            console.log("Client data initialized in Firestore.");
                        }).catch(e => console.error("Error initializing client data:", e));
                    }
                }, (error) => {
                    console.error("Error fetching client data:", error);
                });

                return () => unsubscribeSnapshot();
            }, [isAuthReady, firebaseDb, user, currentUserId]); 

            // Handlers
            const handleLoginSuccess = (loggedInUser) => {
                setUser(loggedInUser);
                setIsChatOpen(loggedInUser.role === 'manager'); // Manager starts in the chat view
            };

            const handleLogout = () => {
                setUser(null);
                setCurrentView('dashboard');
                setIsChatOpen(false);
                // Optionally sign out from Firebase if needed, but for this simulation, clearing local state is sufficient.
            };

            const handleToggleNotification = () => {
                setNotificationActive(prev => !prev);
            };

            // Loading state while waiting for Firebase Auth
            if (!isAuthReady) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <Loader className="w-8 h-8 text-sky-500" />
                        <p className="ml-3 text-slate-600">Chargement de la session...</p>
                    </div>
                );
            }
            
            // Show Login Page if no user is set
            if (!user) {
                return (
                    <LoginPage 
                        onLoginSuccess={handleLoginSuccess}
                        correctClient={INITIAL_DATA.user}
                        correctManager={INITIAL_DATA.manager}
                        bankName={INITIAL_DATA.bankName}
                    />
                );
            }

            // --- Render Logic for Authenticated User ---
            const isClient = user.role === 'client';

            if (!isClient) {
                // Manager View
                return (
                    <div className="h-screen flex flex-col">
                        <Header 
                            userName={user.name} 
                            bankName={INITIAL_DATA.bankName} 
                            onLogout={handleLogout}
                        />
                        <main className="flex-1 overflow-y-auto bg-slate-50">
                            <ManagerDashboard />
                        </main>
                    </div>
                );
            }

            // Client View (Dashboard + Navigation)
            const RenderedView = () => {
                switch (currentView) {
                    case 'transfer':
                        return <TransferView balance={clientBalance} clientUserId={currentUserId} />;
                    case 'card':
                        return <CardView userName={user.name} />;
                    case 'dashboard':
                    default:
                        return (
                            <>
                                {notificationActive && (
                                    <div className="p-4 bg-sky-50 border border-sky-200 rounded-xl mb-6 shadow-sm animate-in fade-in slide-in-from-top-4">
                                        <h4 className="font-bold text-sky-700">Notification Importante</h4>
                                        <p className="text-sm text-sky-600 mt-1">{INITIAL_DATA.notificationMessage}</p>
                                    </div>
                                )}
                                <DashboardView 
                                    balance={clientBalance} 
                                    transactions={clientTransactions}
                                    onOpenChat={() => setIsChatOpen(true)}
                                />
                            </>
                        );
                }
            };

            return (
                <div className="h-screen flex flex-col">
                    <Header 
                        userName={user.name} 
                        bankName={INITIAL_DATA.bankName} 
                        onLogout={handleLogout}
                        onToggleNotification={handleToggleNotification}
                        notificationActive={notificationActive}
                    />
                    
                    <main className={`flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50 ${isChatOpen ? 'hidden md:block' : 'main-content'}`}>
                        <div className="max-w-4xl mx-auto">
                            <RenderedView />
                        </div>
                    </main>

                    {/* Navigation (Fixed at the bottom) */}
                    {!isChatOpen && (
                        <Navigation 
                            currentView={currentView} 
                            setCurrentView={setCurrentView} 
                            onOpenChat={() => setIsChatOpen(true)}
                        />
                    )}

                    {/* Chat Modal/Screen */}
                    {isChatOpen && (
                        <div className={`fixed inset-0 bg-white z-40 md:static md:p-0 md:bg-transparent md:h-auto ${isChatOpen ? 'chat-container-main' : 'hidden'}`}>
                            <ChatWindow 
                                db={firebaseDb} 
                                auth={window.auth}
                                userId={currentUserId} 
                                userName={user.name} 
                                onClose={() => setIsChatOpen(false)}
                                isManager={false}
                            />
                        </div>
                    )}
                </div>
            );
        }

        // ==========================================
        // RENDER
        // ==========================================
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
