<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barclays Banque - Multi-Rôle et Chat</title>
    <!-- Inclure Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuration des polices et des classes personnalisées pour Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        .font-sans {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        /* Style de base pour les transitions */
        .animate-in {
            animation-name: fadeIn;
            animation-duration: 0.3s;
            animation-fill-mode: both;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .slide-in-from-top-4 {
            animation-name: slideInTop;
        }
        @keyframes slideInTop {
            from { transform: translateY(-1rem); }
            to { transform: translateY(0); }
        }
        .slide-in-from-bottom-4 {
            animation-name: slideInBottom;
        }
        @keyframes slideInBottom {
            from { transform: translateY(1rem); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .zoom-in-95 {
            animation-name: zoomIn;
        }
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        /* Simulation de l'icône de Contactless */
        .contactless-icon {
            transform: rotate(90deg);
        }

        /* Fix pour les écrans mobiles pour que la nav n'obstrue pas le contenu */
        @media (max-width: 767px) {
            .main-content {
                padding-bottom: 80px; /* Espace pour la barre de navigation inférieure */
            }
        }
    </style>
    <!-- Inclure React et ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Inclure Babel pour la compilation JSX dans le navigateur -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase CDN Imports (Required for real-time chat) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, limit, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase utilities globally for use in the main babel script
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, 
            query, where, getDocs, orderBy, limit, serverTimestamp, setLogLevel
        };
        
        // Configuration et Initialisation (Doit être dans le module)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Corrected variable name: __firebase_config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; 
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (Object.keys(firebaseConfig).length > 0) {
            try {
                // setLogLevel('debug'); // Uncomment for debugging
                const app = firebase.initializeApp(firebaseConfig);
                window.db = firebase.getFirestore(app);
                window.auth = firebase.getAuth(app);
                window.firebaseReady = true;

                // Sign in with custom token or anonymously
                const signInProcess = initialAuthToken 
                    ? firebase.signInWithCustomToken(window.auth, initialAuthToken)
                    : firebase.signInAnonymously(window.auth);

                signInProcess
                    .then(() => console.log("Firebase signed in."))
                    .catch(error => console.error("Firebase Auth Failed:", error));

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                window.firebaseReady = false;
            }
        } else {
            console.warn("Firebase config not available. Chat features will be limited.");
            window.firebaseReady = false;
        }

        // Expose critical identifiers
        window.appId = appId;
    </script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // SIMULATION DES ICONES LUCIDE-REACT
        // ==========================================
        const Bell = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18.8 12.3a4.5 4.5 0 0 0-4.5-4.5H9.7a4.5 4.5 0 0 0-4.5 4.5v1.2a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-1.2zm-4.3 8a2 2 0 0 1-4 0"/></svg>;
        const LogOut = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>;
        const Home = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>;
        const ArrowRightLeft = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 11 20 14 17 17"/><line x1="4" y1="14" x2="20" y2="14"/><polyline points="7 7 4 10 7 13"/><line x1="20" y1="10" x2="4" y2="10"/></svg>;
        const CreditCard = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>;
        const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Landmark = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="22" x2="21" y2="22"/><path d="M4 14.897V4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10.897M12 2l4 3.5M12 2l-4 3.5M9 8h6M6 18h12"/></svg>;
        const MessageSquare = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>;
        const Loader = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Send = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>;
        const Sparkles = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.9 22c-3.7-.8-6.6-4.5-6.6-7.8s2.9-7 6.6-7.8c.8 1.4 1.2 2.9 1.2 4.4 0 1.5-.4 3-1.2 4.4zm.8-13.4l.7-.7a1 1 0 0 1 1.4 0l.7.7m-2.8 1.4l.7-.7a1 1 0 0 1 1.4 0l.7.7"/><path d="M12 2c-.4 0-.7.3-1 .7a1.6 1.6 0 0 0-1.4 1.5c0 1.2.9 2 2 2 .5 0 1-.2 1.4-.6l1-1c.2-.3.3-.7 0-1L13 2.7c-.2-.4-.6-.7-1-.7z"/><path d="M13 14c0 1.5-.4 3-1.2 4.4-3.7-.8-6.6-4.5-6.6-7.8s2.9-7 6.6-7.8c.8 1.4 1.2 2.9 1.2 4.4z"/></svg>;


        // ==========================================
        // DONNÉES FICTIVES INITIALES
        // ==========================================
        const INITIAL_DATA = {
            bankName: "BARCLAYS",
            user: {
                name: "Lacombe Jacques André marie",
                loginId: "7897620168",
                password: "548521",
                role: 'client',
            },
            manager: {
                name: "Gestionnaire Privé",
                loginId: "1234",
                password: "123456",
                role: 'manager',
            },
            initialBalance: 804038,
            initialTransactions: [
                { id: 1, date: '21/11/2025', recipient: 'Londres royaume unis', account: 'xxxxxxxx', amount: 804038, type: 'credit', description: 'Solde initial' },
            ],
            notificationMessage: "Le bénéfice de 804 038 € a été réalisé grâce à des investissements effectués sur les marchés. Vos fonds ont été temporairement centralisés auprès de la banque Barclays avant d'être transférés sur vos comptes bancaires respectifs, en tant que bénéficiaire légitime de ces avoirs."
        };

        const formatCurrency = (amount, currency = 'EUR') => {
            return new Intl.NumberFormat('fr-FR', { 
                style: 'currency', 
                currency: currency, 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            }).format(amount);
        };

        // ==========================================
        // GEMINI API UTILS
        // ==========================================

        async function performGeminiApiCall(userQuery, systemPrompt, useSearch, maxRetries = 5, initialDelay = 1000) {
            const apiKey = ""; // Canvas will automatically provide the key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: useSearch ? [{ "google_search": {} }] : undefined,
                systemInstruction: systemPrompt ? { parts: [{ text: systemPrompt }] } : undefined,
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Retryable HTTP error: ${response.status}`);
                        }
                        const errorBody = await response.json();
                        console.error("Gemini API Non-retryable Error:", errorBody);
                        return { text: "Erreur: Le service LLM n'a pas pu traiter la requête.", sources: [] };
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);
                        }
                        return { text, sources };
                    }

                    return { text: "Erreur: Réponse inattendue de l'API LLM.", sources: [] };

                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("Gemini API failed after all retries:", error);
                        return { text: "Erreur: Le service LLM est indisponible. Veuillez réessayer plus tard.", sources: [] };
                    }
                    // Exponential backoff delay
                    const delay = initialDelay * Math.pow(2, attempt);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ==========================================
        // FIREBASE UTILS
        // ==========================================
        const CHAT_COLLECTION = "client_manager_chat";
        const ACCOUNT_DOC = "client_balance";

        function getChatCollectionRef(db, appId) {
            // Path: /artifacts/{appId}/public/data/client_manager_chat
            return window.firebase.collection(db, `artifacts/${appId}/public/data/${CHAT_COLLECTION}`);
        }
        
        function getClientDocRef(db, appId, userId) {
            // Path: /artifacts/{appId}/users/{userId}/account_data/client_balance
            return window.firebase.doc(db, `artifacts/${appId}/users/${userId}/account_data/${ACCOUNT_DOC}`);
        }

        // ==========================================
        // CHAT COMPONENTS
        // ==========================================

        function ChatWindow({ db, auth, userId, userName, onClose, isManager }) {
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState('');
            const messagesEndRef = React.useRef(null);
            const [isSending, setIsSending] = React.useState(false);
            const [isBotResponding, setIsBotResponding] = React.useState(false); // New state for AI features

            React.useEffect(() => {
                if (!db || !userId) return;

                const chatRef = getChatCollectionRef(db, window.appId);
                const q = window.firebase.query(chatRef, window.firebase.orderBy('timestamp', 'asc'));

                // Listen for real-time updates
                const unsubscribe = window.firebase.onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        // Ensure timestamp is a Date object for comparison/display
                        timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date(),
                    }));
                    setMessages(msgs);
                }, (error) => {
                    console.error("Error listening to chat messages:", error);
                });

                return () => unsubscribe(); // Cleanup listener on unmount
            }, [db, userId]);

            // Scroll to bottom whenever messages update
            React.useEffect(() => {
                // Ensure scrolling happens after messages are rendered
                const timeout = setTimeout(() => {
                    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
                }, 100); 
                return () => clearTimeout(timeout);
            }, [messages]);


            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!input.trim() || isSending || !db || !userId) return;

                setIsSending(true);
                const chatRef = getChatCollectionRef(db, window.appId);

                try {
                    await window.firebase.addDoc(chatRef, {
                        senderId: userId,
                        senderName: userName,
                        text: input.trim(),
                        timestamp: window.firebase.serverTimestamp(),
                    });
                    setInput('');
                } catch (error) {
                    console.error("Error adding message:", error);
                } finally {
                    setIsSending(false);
                }
            };
            
            // --- GEMINI AI Client Feature: Financial Advice ---
            const handleAIFinancialAdvice = async () => {
                if (isBotResponding) return;

                // 1. Construct chat history context for the prompt
                const chatHistory = messages.map(msg => `${msg.senderName}: ${msg.text}`).join('\n');
                const fullPrompt = `Voici l'historique de la conversation entre le client et son gestionnaire bancaire:
    ---
    ${chatHistory}
    ---
    En vous basant sur cet historique et sur le contexte d'une banque privée (Barclays), fournissez une analyse concise (3 phrases maximum) sur la situation financière évoquée par le client et suggérez une prochaine étape pour l'aider (paiement de frais, contact, etc.).`;

                const systemPrompt = "Vous êtes un conseiller financier IA expert et discret de la banque Barclays. Vous analysez l'historique de chat du client et fournissez des conseils clairs, précis et réconfortants, en français.";

                setIsBotResponding(true);
                
                // Create a placeholder message for the AI response
                const botPlaceholder = {
                    id: 'bot-loading-' + Date.now(),
                    senderName: 'Conseiller IA Barclays',
                    text: 'Analyse en cours... veuillez patienter.',
                    type: 'bot',
                    timestamp: new Date(),
                    isPlaceholder: true,
                    senderId: 'AI_BOT'
                };
                
                setMessages(prev => [...prev, botPlaceholder]);
                
                // Use setTimeout to ensure the loading message is rendered before scrolling and calling the API
                setTimeout(async () => {
                    try {
                        const result = await performGeminiApiCall(fullPrompt, systemPrompt, false);

                        const finalMessage = {
                            id: 'bot-final-' + Date.now(),
                            senderName: 'Conseiller IA Barclays',
                            text: result.text,
                            type: 'bot',
                            timestamp: new Date(),
                            senderId: 'AI_BOT'
                        };

                        // Replace the placeholder with the final message
                        setMessages(prev => prev.map(msg => msg.id === botPlaceholder.id ? finalMessage : msg));

                    } catch (error) {
                        console.error("AI call failed:", error);
                        setMessages(prev => prev.map(msg => msg.id === botPlaceholder.id ? { ...msg, text: "Erreur lors de la communication avec le Conseiller IA.", isPlaceholder: false } : msg));
                    } finally {
                        setIsBotResponding(false);
                    }
                }, 100); 
            };

            // --- GEMINI AI Manager Feature: Draft Professional Response ---
            const handleManagerDraftResponse = async () => {
                if (isBotResponding) return;
                
                // Find the last message sent by the client (senderId is not the current manager's userId and not the AI bot)
                const lastClientMessage = messages.findLast(msg => msg.senderId !== userId && msg.senderId !== 'AI_BOT');

                if (!lastClientMessage) {
                    setInput("Aucun message client récent trouvé pour rédiger une réponse.");
                    return;
                }

                const clientQuery = lastClientMessage.text;
                const fullPrompt = `Le client a envoyé le message suivant : "${clientQuery}". Rédigez une réponse professionnelle, formelle et rassurante du Gestionnaire Privé de la banque Barclays. La réponse doit être en français et ne doit pas dépasser 4 phrases.`;
                const systemPrompt = "Vous êtes un gestionnaire privé de la banque Barclays. Votre ton est formel, courtois et orienté solution. Vous répondez au client de manière professionnelle.";

                setIsBotResponding(true);
                setInput('Génération de la réponse professionnelle...');

                try {
                    const result = await performGeminiApiCall(fullPrompt, systemPrompt, false);
                    
                    // Replace the input with the drafted response
                    setInput(result.text);

                } catch (error) {
                    console.error("AI call failed:", error);
                    setInput('Erreur: Impossible de générer la réponse. Veuillez réessayer.');
                } finally {
                    setIsBotResponding(false);
                }
            };
            // --- End AI Features ---

            const ManagerBadge = ({ name }) => (
                <span className="bg-sky-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">
                    {name}
                </span>
            );

            const BotBadge = () => (
                <span className="bg-purple-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">
                    Conseiller IA
                </span>
            );


            return (
                <div className={`fixed inset-0 bg-white z-50 flex flex-col md:absolute md:top-0 md:bottom-0 md:left-0 md:right-0 md:shadow-xl md:rounded-xl ${!isManager && 'animate-in fade-in slide-in-from-bottom-4'}`}>
                    <div className="flex justify-between items-center p-4 border-b bg-sky-500 text-white rounded-t-xl shadow-md">
                        <h2 className="text-lg font-bold flex items-center gap-2">
                            <MessageSquare className="w-5 h-5" />
                            {isManager ? 'Dialogue Client' : 'Discuter avec votre Gestionnaire'}
                        </h2>
                        <button onClick={onClose} className="p-2 rounded-full hover:bg-white/20 transition-colors">
                            <X className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
                        {messages.length === 0 && (
                            <div className="text-center p-6 text-slate-500 italic">
                                Commencez une conversation. L'ID de conversation est basé sur l'application.
                            </div>
                        )}
                        {messages.map((msg) => {
                            const isMyMessage = msg.senderId === userId;
                            const isBotMessage = msg.senderId === 'AI_BOT';
                            const timeString = msg.timestamp.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                            return (
                                <div key={msg.id} className={`flex ${isMyMessage || isBotMessage ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${
                                        isMyMessage 
                                        ? 'bg-sky-500 text-white rounded-br-none' 
                                        : (isBotMessage 
                                            ? 'bg-purple-100 text-slate-800 rounded-bl-none border border-purple-200'
                                            : 'bg-white text-slate-800 rounded-tl-none border border-slate-200')
                                    }`}>
                                        <div className={`text-xs mb-1 font-semibold flex items-center gap-2 ${isMyMessage ? 'text-sky-100' : 'text-slate-600'}`}>
                                            {!isMyMessage && !isBotMessage && <ManagerBadge name={msg.senderName.split(' ')[0]} />}
                                            {isBotMessage && <BotBadge />} 
                                            {isMyMessage && msg.senderName.split(' ')[0]}
                                        </div>
                                        <p className="text-sm break-words whitespace-pre-wrap">
                                            {msg.isPlaceholder && isBotResponding ? <Loader className="w-4 h-4 mr-2 inline-block text-purple-600" /> : null}
                                            {msg.text}
                                        </p>
                                        <span className={`block text-right mt-1 ${isMyMessage ? 'text-xs text-sky-200' : (isBotMessage ? 'text-xs text-purple-400' : 'text-xs text-slate-400')}`}>
                                            {timeString}
                                        </span>
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={messagesEndRef} />
                    </div>

                    <div className="p-4 border-t bg-white">
                        {/* AI Features Row */}
                        <div className="mb-3 flex gap-2 overflow-x-auto pb-1">
                            {!isManager && (
                                <button
                                    onClick={handleAIFinancialAdvice}
                                    disabled={isBotResponding || messages.length === 0}
                                    className="flex-shrink-0 text-xs px-3 py-2 bg-purple-500 text-white rounded-full font-medium hover:bg-purple-600 disabled:bg-purple-300 transition-colors flex items-center gap-1 shadow-md"
                                >
                                    <Sparkles className="w-3 h-3"/>
                                    Aide Financière IA
                                </button>
                            )}
                            {isManager && (
                                <button
                                    onClick={handleManagerDraftResponse}
                                    disabled={isBotResponding}
                                    className="flex-shrink-0 text-xs px-3 py-2 bg-purple-500 text-white rounded-full font-medium hover:bg-purple-600 disabled:bg-purple-300 transition-colors flex items-center gap-1 shadow-md"
                                >
                                    <Sparkles className="w-3 h-3"/>
                                    Réponse Pro IA
                                </button>
                            )}
                        </div>

                        <form onSubmit={handleSendMessage} className="flex gap-3">
                            <input
                                type="text"
                                value={input}
                                onChange={(e) => setInput(e.target.value)}
                                placeholder="Écrire un message..."
                                className="flex-1 px-4 py-2.5 rounded-full border border-slate-200 focus:border-sky-500 focus:ring-1 focus:ring-sky-100 outline-none"
                                disabled={isSending || isBotResponding || !db || !userId}
                            />
                            <button 
                                type="submit" 
                                className="p-3 bg-sky-500 hover:bg-sky-600 text-white rounded-full transition-colors disabled:bg-sky-300"
                                disabled={isSending || isBotResponding || !input.trim() || !db || !userId}
                            >
                                {isSending ? <Loader className="w-5 h-5" /> : <Send className="w-5 h-5" />}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ==========================================
        // SOUS-COMPOSANTS
        // ==========================================

        function LoginPage({ onLoginSuccess, correctClient, correctManager, bankName }) {
            const [loginId, setLoginId] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                setError('');

                let user = null;

                if (loginId === correctClient.loginId && password === correctClient.password) {
                    user = correctClient;
                } else if (loginId === correctManager.loginId && password === correctManager.password) {
                    user = correctManager;
                }
                
                if (user) {
                    onLoginSuccess(user);
                } else {
                    setError("Identifiants incorrects. Veuillez réessayer.");
                }
            };

            return (
                <div className="flex items-center justify-center min-h-screen bg-gradient-to-br from-sky-100 to-white p-4">
                    <div className="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden animate-in fade-in zoom-in-95">
                        <div className="bg-sky-500 p-6 text-center">
                            <div className="inline-block p-3 rounded-full bg-white/20 mb-2">
                                <Landmark className="text-white w-8 h-8" />
                            </div>
                            <h1 className="text-2xl font-bold text-white tracking-wider">{bankName}</h1>
                            <p className="text-sky-100 text-sm mt-1">Accès Sécurisé</p>
                        </div>
                        
                        <div className="p-8">
                            <form onSubmit={handleSubmit} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Identifiant</label>
                                    <input 
                                        type="text" 
                                        value={loginId} 
                                        onChange={(e) => setLoginId(e.target.value)} 
                                        className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none transition-all bg-slate-50 focus:bg-white"
                                        placeholder="Entrez votre identifiant"
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-600 mb-1">Mot de passe</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        className="w-full px-4 py-3 rounded-lg border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-200 outline-none transition-all bg-slate-50 focus:bg-white"
                                        placeholder="••••••"
                                        required 
                                    />
                                </div>
                                
                                {error && (
                                    <div className="p-3 bg-red-50 border border-red-100 text-red-600 text-sm rounded-lg flex items-center">
                                        <span className="mr-2">⚠</span> {error}
                                    </div>
                                )}

                                <button type="submit" className="w-full bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-lg shadow-sky-500/30 transition-all transform active:scale-[0.98]">
                                    Se connecter
                                </button>
                                
                                <div className="text-center mt-4 p-3 bg-slate-50 rounded-lg">
                                    <p className="text-xs text-slate-500 font-bold mb-1">Accès Client (M. Lacombe):</p>
                                    <p className="text-xs text-slate-400">ID: {correctClient.loginId} | MDP: {correctClient.password}</p>
                                    <p className="text-xs text-slate-500 font-bold mt-2 mb-1">Accès Gestionnaire:</p>
                                    <p className="text-xs text-slate-400">ID: {correctManager.loginId} | MDP: {correctManager.password}</p>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }

        function Header({ userName, bankName, onLogout, onToggleNotification, notificationActive }) {
            return (
                <header className="bg-white border-b border-slate-200 sticky top-0 z-20 px-4 py-3 md:px-6 flex justify-between items-center shadow-sm">
                    <div className="flex items-center gap-2">
                        <div className="bg-sky-500 p-1.5 rounded-lg">
                            <Landmark className="text-white w-5 h-5" />
                        </div>
                        <span className="font-bold text-xl text-sky-600 tracking-tight">{bankName}</span>
                    </div>
                    
                    <div className="flex items-center gap-3 md:gap-6">
                        <span className="hidden md:block text-sm font-medium text-slate-600">
                            Bonjour, <span className="text-slate-900 font-bold">{userName.split(' ')[0]}</span>
                        </span>
                        
                        {/* Notification Button is only relevant for Client Dashboard */}
                        {onToggleNotification && (
                            <button 
                                onClick={onToggleNotification}
                                className={`relative p-2 rounded-full transition-colors ${notificationActive ? 'bg-sky-50 text-sky-600' : 'hover:bg-slate-100 text-slate-500'}`}
                            >
                                <Bell className="w-5 h-5" />
                                {notificationActive && (
                                    <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 border-2 border-white rounded-full"></span>
                                )}
                            </button>
                        )}
                        
                        <button 
                            onClick={onLogout} 
                            className="flex items-center gap-2 text-slate-500 hover:text-red-500 transition-colors text-sm font-medium"
                        >
                            <span className="hidden md:inline">Déconnexion</span>
                            <LogOut className="w-4 h-4" />
                        </button>
                    </div>
                </header>
            );
        }

        function Navigation({ currentView, setCurrentView, onOpenChat }) {
            const navItems = [
                { id: 'dashboard', label: 'Tableau de bord', icon: Home },
                { id: 'transfer', label: 'Virement', icon: ArrowRightLeft },
                { id: 'card', label: 'Carte', icon: CreditCard },
                { id: 'chat', label: 'Dialogue', icon: MessageSquare, action: onOpenChat, type: 'button' },
            ];

            return (
                <nav className="md:w-64 bg-white border-r border-slate-200 flex md:flex-col justify-around md:justify-start fixed bottom-0 w-full md:relative md:h-auto z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] md:shadow-none p-2 md:p-4 gap-1 md:gap-2">
                    {navItems.map((item) => {
                        const Icon = item.icon;
                        const isActive = currentView === item.id;
                        const action = item.action || (() => setCurrentView(item.id));

                        return (
                            <button
                                key={item.id}
                                onClick={action}
                                className={`flex flex-col md:flex-row items-center md:gap-3 p-2 md:px-4 md:py-3 rounded-lg transition-all w-full md:text-left text-xs md:text-sm font-medium
                                    ${isActive && item.id !== 'chat'
                                        ? 'text-sky-600 bg-sky-50 md:bg-sky-50' 
                                        : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'}`}
                            >
                                <Icon className={`w-6 h-6 md:w-5 md:h-5 mb-1 md:mb-0 ${isActive && item.id !== 'chat' ? 'stroke-[2.5px]' : ''}`} />
                                <span>{item.label}</span>
                            </button>
                        );
                    })}
                </nav>
            );
        }

        function DashboardView({ balance, transactions, onOpenChat }) {
            return (
                <div className="space-y-6 animate-in fade-in zoom-in-95 duration-300">
                    {/* Balance Card */}
                    <div className="bg-gradient-to-r from-sky-500 to-sky-600 rounded-2xl p-6 text-white shadow-lg shadow-sky-500/20 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -mr-16 -mt-32 blur-2xl"></div>
                        <div className="relative z-10">
                            <h2 className="text-sky-100 text-sm font-medium mb-1">Solde disponible</h2>
                            <p className="text-4xl font-bold mb-4">{formatCurrency(balance)}</p>
                            <div className="flex items-center justify-between bg-white/10 rounded-lg p-3 backdrop-blur-sm">
                                <div>
                                    <p className="text-xs text-sky-100">IBAN</p>
                                    <p className="font-mono text-sm">FR76 BARC 2000 1000 1234 5678 901</p>
                                </div>
                                <CreditCard className="w-6 h-6 text-sky-200" />
                            </div>
                        </div>
                    </div>

                    {/* Quick Action - Chat */}
                    <div className="flex justify-center md:justify-start">
                        <button 
                            onClick={onOpenChat}
                            className="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg shadow-purple-500/30 transition-all transform active:scale-[0.98]"
                        >
                            <MessageSquare className="w-5 h-5" />
                            Écrire à mon Gestionnaire
                        </button>
                    </div>

                    {/* Transactions */}
                    <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h3 className="font-semibold text-slate-700">Historique des transactions</h3>
                            <span className="text-xs font-medium text-sky-600 bg-sky-50 px-2 py-1 rounded-full">Dernières</span>
                        </div>
                        <ul className="divide-y divide-slate-100">
                            {transactions.map(tx => (
                                <li key={tx.id} className="px-6 py-4 hover:bg-slate-50 transition-colors flex items-center justify-between group">
                                    <div className="flex items-start gap-4">
                                        <div className={`p-2 rounded-full ${tx.type === 'debit' ? 'bg-slate-100 text-slate-500' : 'bg-green-100 text-green-600'}`}>
                                            {tx.type === 'debit' ? <ArrowRightLeft className="w-5 h-5" /> : <ArrowRightLeft className="w-5 h-5 rotate-180" />}
                                        </div>
                                        <div>
                                            <p className="font-medium text-slate-900">{tx.recipient}</p>
                                            <p className="text-sm text-slate-500 font-mono">{tx.account}</p>
                                            {tx.description && <p className="text-xs text-slate-400 mt-0.5 italic">{tx.description}</p>}
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className={`font-bold ${tx.type === 'debit' ? 'text-red-600' : 'text-green-600'}`}>
                                            {tx.type === 'credit' && tx.amount > 0 && '+'}{formatCurrency(tx.amount)}
                                        </p>
                                        <p className="text-xs text-slate-400">{tx.date}</p>
                                    </div>
                                </li>
                            ))}
                        </ul>
                        {transactions.length === 0 && (
                            <div className="text-center p-8 text-slate-500 italic">
                                Aucune transaction récente.
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function TransferView({ balance, clientUserId }) {
            const [formData, setFormData] = React.useState({
                securityCode: '',
                iban: '',
                bic: '',
                amount: '',
                bankName: '',
                transferType: 'Virement international', // Default to INT for scenario
                recipientName: '',
                reason: ''
            });
            const [message, setMessage] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(false);
            const db = window.firebaseReady ? window.db : null;

            const handleChange = (e) => {
                const { name, value } = e.target;
                const newValue = name === 'amount' && parseFloat(value) < 0 
                                 ? Math.abs(parseFloat(value)) 
                                 : value;
                setFormData({ ...formData, [name]: newValue });
                setMessage(null);
            };

            const updateClientData = async (newBalance, newTransaction) => {
                if (!db || !clientUserId) return;
                const docRef = getClientDocRef(db, window.appId, clientUserId);

                try {
                    await window.firebase.updateDoc(docRef, {
                        balance: newBalance,
                        transactions: window.firebase.arrayUnion(newTransaction),
                        lastUpdate: window.firebase.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error updating client data:", error);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                const amountNum = parseFloat(formData.amount);
                
                if (!formData.recipientName || !formData.iban || amountNum <= 0) {
                    setMessage({ type: 'error', text: "Veuillez remplir les champs obligatoires (Montant, IBAN, Nom du bénéficiaire) avec des valeurs valides." });
                    return;
                }
                
                if (amountNum > balance) {
                    setMessage({ type: 'error', text: "Solde insuffisant pour effectuer ce virement." });
                    return;
                }

                setIsLoading(true);
                setMessage({ type: 'info', text: "Traitement du virement international en cours... (Simulation de 5 minutes)" });

                // Simulation de 5 minutes (3 secondes réelles)
                setTimeout(async () => {
                    setIsLoading(false);
                    
                    // --- SCENARIO: Forced SWIFT Failure ---
                    // Hardcoded values to trigger a specific scenario, regardless of form input
                    const failedAmount = amountNum; 
                    const feeRate = 0.01;
                    const fee = failedAmount * feeRate;
                    const remainingBalance = balance - fee; // Charge the fee even on failure (common tactic in scams)

                    const failedTransaction = {
                        id: Date.now(),
                        date: new Date().toLocaleDateString('fr-FR'),
                        recipient: formData.recipientName,
                        account: formData.iban,
                        amount: -fee,
                        type: 'debit',
                        description: 'Frais de virement SWIFT (Échec de transaction)',
                        status: 'Failed'
                    };

                    // 1. Update the balance to deduct the fee (only if balance is sufficient)
                    if (remainingBalance >= 0) {
                        await updateClientData(remainingBalance, failedTransaction);
                    } else {
                        // If fee deduction would make balance negative, just show the message without deducting
                        console.error("Not enough balance to deduct the fee.");
                    }

                    // 2. Display the detailed failure message
                    setMessage({
                        type: 'error',
                        text: (
                            <div className="text-sm">
                                <p className="font-bold mb-2">ÉCHEC DE TRANSACTION (Nécessite une intervention)</p>
                                <ul className="list-disc list-inside space-y-0.5 mb-3">
                                    <li>Nom du bénéficiaire: {formData.recipientName}</li>
                                    <li>IBAN / Numéro de Compte: {formData.iban}</li>
                                    <li>Montant Initial: {formatCurrency(failedAmount)}</li>
                                </ul>
                                <p className="mt-2 leading-relaxed">
                                    Nous vous notifions que la transaction a été *interrompue* en raison de l'application obligatoire de frais de virement SWIFT (International) s'élevant à 1% du montant total. 
                                    <span className="font-bold block mt-1">Veuillez contacter votre gestionnaire pour autoriser le paiement de ces frais afin de débloquer le virement.</span>
                                </p>
                            </div>
                        )
                    });
                    
                    // Reset form after simulated attempt (optional: only amount/security code)
                    setFormData(prev => ({ ...prev, securityCode: '', amount: '' }));

                }, 3000); // 3 seconds simulation of 5 minutes
            };

            const inputClasses = "w-full px-4 py-2.5 rounded-lg border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-100 outline-none transition-all";

            return (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-6 md:p-8 animate-in fade-in slide-in-from-bottom-4 duration-300">
                    <div className="mb-6">
                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                            <ArrowRightLeft className="text-sky-500" /> Virement Bancaire
                        </h2>
                        <p className="text-slate-500 text-sm">Votre solde actuel : <span className="font-bold text-slate-800">{formatCurrency(balance)}</span>. Remplissez les informations ci-dessous.</p>
                    </div>

                    {message && (
                        <div className={`mb-6 p-4 rounded-lg text-sm ${
                            message.type === 'error' ? 'bg-red-50 text-red-600 border border-red-200' : 
                            message.type === 'info' ? 'bg-yellow-50 text-yellow-600 border border-yellow-200' : 
                            'bg-green-50 text-green-600 border border-green-200'
                        }`}>
                            {message.text}
                        </div>
                    )}

                    <form onSubmit={handleSubmit} className="space-y-5">
                        <div className="grid md:grid-cols-2 gap-5">
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Code de sécurité</label>
                                <input type="password" name="securityCode" value={formData.securityCode} onChange={handleChange} className={inputClasses} placeholder="Mot de passe ou Code PIN" />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">IBAN / Numéro de Compte *</label>
                                <input type="text" name="iban" value={formData.iban} onChange={handleChange} placeholder="FR76...." className={inputClasses} required />
                            </div>
                        </div>

                        <div className="grid md:grid-cols-3 gap-5">
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Code Banque (BIC / SWIFT)</label>
                                <input type="text" name="bic" value={formData.bic} onChange={handleChange} className={inputClasses} placeholder="BARCFRPP" />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Nom de la banque</label>
                                <input type="text" name="bankName" value={formData.bankName} onChange={handleChange} className={inputClasses} placeholder="Banque du bénéficiaire" />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Type de virement:</label>
                                <select name="transferType" value={formData.transferType} onChange={handleChange} className={inputClasses}>
                                    <option>Virement standard (SEPA)</option>
                                    <option>Virement instantané (SEPA)</option>
                                    <option>Virement international (SWIFT)</option>
                                </select>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700">Montant à envoyer (€) *</label>
                            <div className="relative">
                                <input 
                                    type="number" 
                                    name="amount" 
                                    value={formData.amount} 
                                    onChange={handleChange} 
                                    min="0.01" 
                                    step="0.01" 
                                    className="w-full pl-4 pr-12 py-3 rounded-lg border border-slate-200 focus:border-sky-500 focus:ring-2 focus:ring-sky-100 outline-none transition-all text-lg font-medium text-slate-900"
                                    required 
                                />
                                <span className="absolute right-4 top-3.5 text-slate-400 font-bold">EUR</span>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-5">
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Nom du bénéficiaire *</label>
                                <input type="text" name="recipientName" value={formData.recipientName} onChange={handleChange} className={inputClasses} required />
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-slate-700">Motif du virement</label>
                                <input type="text" name="reason" value={formData.reason} onChange={handleChange} className={inputClasses} />
                            </div>
                        </div>

                        <div className="pt-4">
                            <button type="submit" 
                                className="w-full md:w-auto bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-sky-500/20 transition-all transform active:scale-[0.98] disabled:bg-sky-300 flex items-center justify-center gap-3"
                                disabled={isLoading}
                            >
                                {isLoading && <Loader className="w-5 h-5" />}
                                {isLoading ? "En cours..." : "Valider le virement"}
                            </button>
                        </div>
                    </form>
                </div>
            );
        }

        function ManagerDashboard({ db, auth, userId, userName, onLogout }) {
            // Manager uses his Firebase UID but displays the client's conversation via the public chat collection
            // The Manager's view is focused entirely on the Chat Window
            return (
                <div className="flex flex-col h-screen">
                    <Header 
                        userName={userName} 
                        bankName={INITIAL_DATA.bankName}
                        onLogout={onLogout}
                    />
                    <main className="flex-1 p-4 md:p-8 bg-slate-100 overflow-hidden">
                        <div className="max-w-4xl mx-auto h-full flex flex-col">
                            <div className="mb-4 p-4 bg-sky-100 rounded-xl border border-sky-200">
                                <h1 className="text-2xl font-bold text-sky-800">Espace Gestionnaire</h1>
                                <p className="text-sky-700">Répondez aux préoccupations du client M. Lacombe via le dialogue ci-dessous.</p>
                                <p className="text-xs mt-2 text-slate-500">Votre ID (Gestionnaire) : {userId}</p>
                            </div>
                            
                            <div className="flex-1 relative min-h-[50vh] md:min-h-0">
                                <ChatWindow 
                                    db={db} 
                                    auth={auth} 
                                    userId={userId} 
                                    userName={userName} 
                                    onClose={() => {}} // No close button on manager main view
                                    isManager={true}
                                />
                            </div>
                        </div>
                    </main>
                </div>
            );
        }
        
        function NotificationPanel({ message, onClose }) {
            return (
                <div className="absolute top-16 right-4 md:right-6 z-30 w-full max-w-sm animate-in fade-in slide-in-from-top-4 duration-300">
                    <div className="bg-white rounded-xl shadow-xl border border-sky-100 overflow-hidden">
                        <div className="bg-sky-500 px-4 py-3 flex justify-between items-center">
                            <h3 className="text-white font-medium text-sm flex items-center gap-2">
                                <Bell className="w-4 h-4" /> Information Importante
                            </h3>
                            <button onClick={onClose} className="text-white/80 hover:text-white">
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="p-4 bg-sky-50/50">
                            <p className="text-sm text-slate-700 leading-relaxed">{message}</p>
                        </div>
                    </div>
                </div>
            );
        }
        
        function CardView({ userName }) {
            return (
                <div className="animate-in fade-in zoom-in-95 duration-300">
                    <h2 className="text-xl font-bold text-slate-800 mb-6">Votre Carte Bancaire</h2>
                    <div className="flex flex-col items-center">
                        <div className="w-full max-w-[380px] aspect-[1.586] rounded-2xl p-6 relative text-white shadow-2xl overflow-hidden transform transition-transform hover:scale-105 duration-300 group">
                            <div className="absolute inset-0 bg-gradient-to-bl from-[#2c3e50] to-[#000000] z-0"></div>
                            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-20 z-0"></div>
                            <div className="absolute -top-20 -right-20 w-60 h-60 bg-sky-500 rounded-full blur-[60px] opacity-40"></div>
                            <div className="absolute bottom-0 left-0 w-40 h-40 bg-purple-500 rounded-full blur-[50px] opacity-30"></div>
                            <div className="relative z-10 h-full flex flex-col justify-between">
                                <div className="flex justify-between items-start">
                                    <div className="w-12 h-9 bg-gradient-to-br from-yellow-200 to-yellow-500 rounded-md border border-yellow-600/50 flex items-center justify-center overflow-hidden relative shadow-sm">
                                        <div className="absolute w-full h-[1px] bg-yellow-800/40 top-1/3"></div>
                                        <div className="absolute w-full h-[1px] bg-yellow-800/40 bottom-1/3"></div>
                                        <div className="absolute h-full w-[1px] bg-yellow-800/40 left-1/3"></div>
                                        <div className="absolute h-full w-[1px] bg-yellow-800/40 right-1/3"></div>
                                        <div className="w-4 h-4 border border-yellow-800/40 rounded-sm"></div>
                                    </div>
                                    <svg className="w-6 h-6 opacity-80 contactless-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                                    </svg>
                                </div>
                                <div className="mt-4">
                                    <div className="text-xl md:text-2xl font-mono tracking-widest drop-shadow-md">4970 1023 4567 8910</div>
                                </div>
                                <div className="flex justify-between items-end mt-auto">
                                    <div className="flex flex-col">
                                        <span className="text-[10px] uppercase text-slate-300 tracking-wider mb-0.5">Titulaire</span>
                                        <span className="font-medium tracking-wide uppercase text-sm md:text-base truncate max-w-[200px]">{userName}</span>
                                    </div>
                                    <div className="flex flex-col items-center mr-4">
                                        <span className="text-[8px] uppercase text-slate-300">Expires</span>
                                        <span className="font-mono text-sm">11/28</span>
                                    </div>
                                    <div className="italic font-bold text-2xl tracking-tighter leading-none">
                                        VISA
                                        <span className="block text-[8px] not-italic font-normal tracking-normal text-right">Premium</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="mt-8 bg-white p-6 rounded-xl border border-slate-200 shadow-sm w-full max-w-md">
                            <h3 className="font-semibold text-slate-800 mb-4">Détails de la carte</h3>
                            <div className="space-y-3 text-sm">
                                <div className="flex justify-between py-2 border-b border-slate-100">
                                    <span className="text-slate-500">Statut</span>
                                    <span className="text-green-600 font-medium flex items-center gap-1">
                                        <span className="w-2 h-2 rounded-full bg-green-500"></span> Active
                                    </span>
                                </div>
                                <div className="flex justify-between py-2 border-b border-slate-100">
                                    <span className="text-slate-500">Type</span>
                                    <span className="text-slate-800">Débit immédiat</span>
                                </div>
                                <div className="flex justify-between py-2 border-b border-slate-100">
                                    <span className="text-slate-500">Plafond hebdomadaire</span>
                                    <span className="text-slate-800 font-mono">5 000,00 €</span>
                                </div>
                                <div className="flex justify-between py-2">
                                    <span className="text-slate-500">Sans contact</span>
                                    <span className="text-slate-800">Activé</span>
                                </div>
                            </div>
                            <button className="mt-6 w-full py-2 border border-red-200 text-red-600 rounded-lg text-sm font-medium hover:bg-red-50 transition-colors">
                                Faire opposition
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // ==========================================
        // COMPOSANT PRINCIPAL APP
        // ==========================================
        function App() {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [user, setUser] = React.useState(null);
            const [role, setRole] = React.useState(null);
            const [currentView, setCurrentView] = React.useState('dashboard');

            // Client Data States (managed by Firestore now)
            const [balance, setBalance] = React.useState(INITIAL_DATA.initialBalance);
            const [transactions, setTransactions] = React.useState(INITIAL_DATA.initialTransactions);
            const [showNotification, setShowNotification] = React.useState(true); // Show initial notification
            const [showChat, setShowChat] = React.useState(false);

            const db = window.firebaseReady ? window.db : null;
            const auth = window.firebaseReady ? window.auth : null;
            
            // Derive a stable ID for data access, preferring Firebase UID once logged in
            const userId = auth?.currentUser?.uid || user?.loginId || null;
            const clientLoginId = INITIAL_DATA.user.loginId;


            // Data Listener (Firestore) - Only for client's dashboard data
            React.useEffect(() => {
                // Only run for client data, and only if Firebase is ready and the client is effectively the user
                if (!db || !userId || role !== 'client') return;

                const docRef = getClientDocRef(db, window.appId, clientLoginId);

                // Check and initialize/listen
                const checkAndListen = async () => {
                    const docSnap = await window.firebase.getDoc(docRef);
                    
                    if (!docSnap.exists()) {
                        // Initialize data in Firestore if it doesn't exist
                        console.log("Initializing client data in Firestore.");
                        const initialData = {
                            balance: INITIAL_DATA.initialBalance,
                            transactions: INITIAL_DATA.initialTransactions,
                            userName: INITIAL_DATA.user.name,
                            lastUpdate: window.firebase.serverTimestamp()
                        };
                        // Use clientLoginId as the path element for the initial client data document, regardless of auth UID
                        await window.firebase.setDoc(docRef, initialData, { merge: true });
                        console.log("Initial data set successfully.");
                    }

                    // Start listening for real-time updates
                    const unsubscribe = window.firebase.onSnapshot(docRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            setBalance(data.balance || INITIAL_DATA.initialBalance);
                            // Deserialize transactions array
                            setTransactions(data.transactions || INITIAL_DATA.initialTransactions);
                        }
                    }, (error) => {
                        console.error("Error fetching client data:", error);
                    });
                    
                    return unsubscribe;
                };

                let unsubscribe;
                checkAndListen().then(unsub => { unsubscribe = unsub; });

                return () => unsubscribe && unsubscribe();
            }, [db, userId, role]);


            const handleLoginSuccess = (loggedInUser) => {
                setUser(loggedInUser);
                setRole(loggedInUser.role);
                setIsLoggedIn(true);
                setCurrentView('dashboard');
                if (loggedInUser.role === 'manager') {
                    // Manager's main view is the chat, but we keep currentView as 'dashboard' 
                    // to prevent Navigation from trying to draw non-existent manager links.
                    setShowChat(true); 
                }
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setUser(null);
                setRole(null);
                setShowNotification(false);
                setShowChat(false);
            };

            // Render Manager Dashboard
            if (role === 'manager') {
                return (
                    <ManagerDashboard
                        db={db}
                        auth={auth}
                        userId={userId} // Manager's real Firebase UID
                        userName={INITIAL_DATA.manager.name}
                        onLogout={handleLogout}
                    />
                );
            }

            // Render Client Dashboard
            if (role === 'client') {
                return (
                    <div className="app-container min-h-screen bg-slate-50 font-sans text-slate-700">
                        <div className="dashboard-container flex flex-col min-h-screen">
                            <Header 
                                userName={INITIAL_DATA.user.name} 
                                bankName={INITIAL_DATA.bankName}
                                onLogout={handleLogout}
                                onToggleNotification={() => setShowNotification(!showNotification)}
                                notificationActive={showNotification}
                            />
                            
                            {showNotification && (
                                <NotificationPanel message={INITIAL_DATA.notificationMessage} onClose={() => setShowNotification(false)} />
                            )}

                            <div className="flex flex-1 relative overflow-auto md:overflow-hidden">
                                {/* Sidebar Navigation for Desktop / Bottom for Mobile */}
                                <div className="hidden md:block">
                                    <Navigation 
                                        currentView={currentView} 
                                        setCurrentView={(view) => {
                                            setCurrentView(view);
                                            setShowChat(false);
                                        }}
                                        onOpenChat={() => setShowChat(true)}
                                    />
                                </div>
                                
                                <main className="main-content flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50">
                                    <div className="max-w-4xl mx-auto">
                                        {showChat ? (
                                            <ChatWindow 
                                                db={db} 
                                                auth={auth}
                                                userId={userId} // Client's real Firebase UID
                                                userName={INITIAL_DATA.user.name} 
                                                onClose={() => setShowChat(false)} 
                                                isManager={false}
                                            />
                                        ) : (
                                            <>
                                                {currentView === 'dashboard' && (
                                                    <DashboardView 
                                                        balance={balance} 
                                                        transactions={transactions} 
                                                        onOpenChat={() => setShowChat(true)}
                                                    />
                                                )}
                                                {currentView === 'transfer' && (
                                                    <TransferView 
                                                        balance={balance} 
                                                        clientUserId={clientLoginId} // Use the specific login ID to target the correct document
                                                    />
                                                )}
                                                {currentView === 'card' && (
                                                    <CardView userName={INITIAL_DATA.user.name} />
                                                )}
                                            </>
                                        )}
                                    </div>
                                </main>
                                
                                {/* Bottom Navigation for Mobile */}
                                <div className="block md:hidden">
                                    <Navigation 
                                        currentView={currentView} 
                                        setCurrentView={(view) => {
                                            setCurrentView(view);
                                            setShowChat(false);
                                        }}
                                        onOpenChat={() => setShowChat(true)}
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Default to Login Page
            return (
                <LoginPage 
                    onLoginSuccess={handleLoginSuccess} 
                    correctClient={INITIAL_DATA.user} 
                    correctManager={INITIAL_DATA.manager}
                    bankName={INITIAL_DATA.bankName} 
                />
            );
        }

        // Rendu de l'application dans l'élément root
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>